# CAD 合规性检查器 - 完整项目开发计划

> **项目愿景**: 构建 AI 驱动的 CAD 图纸自动检查系统，支持 GB/T 14665-2012 标准  
> **当前版本**: v1.0 (Phase 1 完成 85%)  
> **最后更新**: 2025-10-18

---

## 📊 项目进度总览

```
Phase 1 (MVP)         ████████████████░░ 85% ✅ 大部分完成
Phase 2 (Advanced)    ██░░░░░░░░░░░░░░░░ 15% 🔄 开发中  
Phase 3 (AI-Powered)  ░░░░░░░░░░░░░░░░░░  0% 📅 计划中
```

### 里程碑时间线

| 阶段 | 开始时间 | 完成时间 | 状态 | 完成度 |
|------|---------|---------|------|--------|
| Phase 1 | 2025-10-13 | 2025-10-25 | 🔄 进行中 | 85% |
| Phase 2 | 2025-10-20 | 2025-11-15 | 📅 计划中 | 15% |
| Phase 3 | 2025-11-15 | 2025-12-31 | 📅 计划中 | 0% |

---

## 🎯 Phase 1: MVP - 基础规则引擎 (85% 完成)

### 目标
快速启动核心产品，自动化最常见、确定性的检查项，提供初始价值。

### 已完成功能 ✅

#### 1. **P1-F01: 文件上传与解析** ✅
- [x] 前端拖放上传界面 (Drag & Drop)
- [x] 支持 DXF 格式文件 (ezdxf)
- [x] 支持 DWG 格式文件 (多策略转换)
- [x] 文件大小限制 (10MB)
- [x] 实时上传进度显示
- [x] 错误处理与友好提示
- [x] Vercel Serverless 部署
- [x] 统一 `/api/check` 端点 (上传+分析合一)

**技术实现**:
```
frontend/api/check.py        - Serverless function
frontend/checker/parser.py   - DXF/DWG 解析器
frontend/checker/models.py   - 数据模型
```

#### 2. **P1-F02: 原始属性检查器** ✅
- [x] 图层规范检查 (GB/T 14665-2012 表6)
  - [x] 尺寸标注图层检查
  - [x] 文字图层检查
  - [x] 隐藏/冻结图层检测 🆕
- [x] 线宽规范检查 (表1)
  - [x] 标准线宽验证 (0.7mm, 0.5mm, 0.25mm)
  - [x] 容差范围检查
- [x] 颜色规范检查 (表2)
  - [x] 非标准颜色统计
- [x] 字体规范检查 (表3)
  - [x] 文字高度验证
  - [x] 最小/最大高度检查
- [x] 尺寸标注检查 (6.3节)
  - [x] 尺寸终端一致性 (95% 阈值)
  - [x] 尺寸文字高度检查

**技术实现**:
```
frontend/checker/checker.py  - 核心检查逻辑
config/rules_gbt14665.yaml   - 规则配置
```

#### 3. **P1-F03: 基础合规报告** ✅
- [x] 实时分析状态轮询
- [x] 合规得分计算 (0-100分)
- [x] 违规项详细列表
- [x] 严重程度分级 (严重/警告/提示)
- [x] 实体详细信息展示 🆕
  - [x] 尺寸标注: 测量值、显示文字、位置
  - [x] 文字: 内容、高度、位置、样式
  - [x] 线宽: 当前值、推荐值、标准值
- [x] 修复建议
- [x] JSON 导出
- [x] HTML 导出 (含实体详情)
- [x] 响应式 UI 设计

**技术实现**:
```
frontend/app/report/[id]/page.tsx  - 报告页面
frontend/types/index.ts            - TypeScript 类型
backend/app/api/report.py          - 报告 API
```

### 进行中功能 🔄

#### 4. **隐藏图元检测与处理** 🔄 (刚完成)
- [x] 图层关闭状态检测
- [x] 图层冻结状态检测
- [x] 图元不可见属性检测
- [x] 详细统计与分组
- [x] 故障排查文档
- [x] AutoLISP 修复脚本
- [ ] 前端可视化标记隐藏图层

**文档**:
```
docs/HIDDEN_ENTITIES_TROUBLESHOOTING.md  - 完整排查指南
```

### 待完成功能 📋

#### 5. **DWG 转换优化** (优先级: 高)
- [ ] 自动检测最佳转换器
- [ ] 转换失败智能降级
- [ ] 转换进度实时反馈
- [ ] 支持更多 DWG 版本 (R12-R2024)
- [ ] 转换质量验证

#### 6. **报告导出增强** (优先级: 中)
- [ ] PDF 导出 (带图纸预览)
- [ ] CSV 导出 (用于批量分析)
- [ ] Excel 导出 (含统计图表)
- [ ] 自定义报告模板

#### 7. **用户体验优化** (优先级: 中)
- [ ] 批量文件上传
- [ ] 历史记录管理
- [ ] 报告对比功能
- [ ] 深色模式支持
- [ ] 多语言支持 (中/英)

---

## 🚀 Phase 2: 高级空间与视觉分析 (15% 完成)

### 目标
增强检测能力，识别需要算法和视觉分析的复杂几何与空间关系错误。

### 已完成功能 ✅

#### 1. **几何引擎基础** ✅
- [x] GeometryEngine 类框架
- [x] 基本几何计算工具
  - [x] 点到线段距离
  - [x] 线段交点计算
  - [x] 矩形边界框生成

**技术实现**:
```
frontend/checker/geometry.py  - 几何引擎
```

### 进行中功能 🔄

#### 2. **P2-F01: 几何关系引擎** 🔄
- [x] 基础框架搭建
- [ ] Shapely 集成
- [ ] 尺寸线与文字相交检测
- [ ] 尺寸线端点与界线距离验证
- [ ] 对齐检测算法
  - [ ] 垂直对齐
  - [ ] 水平对齐
  - [ ] 小数点对齐

**技术栈**:
- Shapely 2.0+ (几何计算)
- NumPy (数值计算)

**预期检测能力**:
```python
# 示例：尺寸线文字相交检测
violations = geometry_engine.check_dimension_text_overlap(
    dimensions=dxf_data['dimensions'],
    texts=dxf_data['texts']
)
```

### 待开发功能 📋

#### 3. **P2-F02: 计算机视觉子系统** (优先级: 高)
**目标**: 检测视觉混乱和难以阅读的区域

**核心功能**:
- [ ] ROI (感兴趣区域) 自动识别
  - [ ] 锐角标注检测 (<45°)
  - [ ] 密集注释区域检测
  - [ ] 文字重叠检测
  - [ ] 线条拥挤检测
- [ ] CAD 图纸渲染引擎
  - [ ] DXF → PNG/SVG 转换
  - [ ] ROI 区域裁剪
  - [ ] 分辨率自适应
- [ ] CV 模型训练与部署
  - [ ] 数据集生成 (CadQuery)
  - [ ] 清晰度分类模型
  - [ ] 模型量化与优化
  - [ ] ONNX Runtime 部署

**技术栈**:
- PyTorch/TensorFlow (模型训练)
- OpenCV (图像处理)
- CadQuery (合成数据生成)
- ONNX Runtime (模型推理)

**数据集规划**:
```
dataset/
├── clear/           # 清晰样本
│   ├── aligned_dims/
│   ├── proper_spacing/
│   └── readable_text/
└── unclear/         # 混乱样本
    ├── overlapping/
    ├── acute_angles/
    └── dense_annotations/
```

**训练流程**:
1. 使用 CadQuery 生成 10,000+ 合成样本
2. 手动标注 1,000+ 真实样本
3. 训练轻量级分类器 (MobileNetV3/EfficientNet)
4. 模型验证 (accuracy > 90%)
5. 导出 ONNX 格式部署

#### 4. **P2-F03: 交互式可视化报告** (优先级: 高)
**目标**: 在图纸上精确显示错误位置

**核心功能**:
- [ ] 图纸 SVG 渲染器
  - [ ] DXF entities → SVG 转换
  - [ ] 图层控制
  - [ ] 缩放与平移
- [ ] 双栏视图
  - [ ] 左侧：错误列表
  - [ ] 右侧：图纸预览
- [ ] 交互式定位
  - [ ] 点击错误自动定位
  - [ ] 错误区域高亮
  - [ ] 平滑动画过渡
- [ ] 视觉覆盖层
  - [ ] CV 检测区域标记
  - [ ] 热力图显示
  - [ ] 错误密度分布

**技术栈**:
- D3.js / SVG.js (图纸渲染)
- React + Zustand (状态管理)
- Framer Motion (动画)

**UI 设计**:
```
┌─────────────────────────────────────────┐
│  错误列表 (30%)  │   图纸预览 (70%)    │
├─────────────────┼─────────────────────┤
│ ⚠️ 尺寸标注错误  │   [图纸 SVG]        │
│ 📍 图层: DIM     │   🔴 高亮错误区域    │
│ 测量值: 150mm   │   🔍 缩放控制        │
│ [点击定位]      │   🎨 图层控制        │
├─────────────────┤                     │
│ ⚠️ 文字重叠     │                     │
│ 📍 (125, 230)   │                     │
│ [点击定位]      │                     │
└─────────────────┴─────────────────────┘
```

#### 5. **块（Block）递归解析** (优先级: 中)
**目标**: 支持检查块定义内部的图元

**核心功能**:
- [ ] 块定义提取
- [ ] 块引用展开
- [ ] 块内图元检查
- [ ] 嵌套块处理
- [ ] 变换矩阵应用

**技术挑战**:
- 坐标变换 (旋转、缩放、镜像)
- 递归深度限制
- 性能优化

#### 6. **批处理与 CLI** (优先级: 中)
**目标**: 支持命令行批量检查

**核心功能**:
- [ ] CLI 工具开发
  ```bash
  cad-checker check ./drawings/*.dxf \
    --standard GB/T14665 \
    --output reports/
  ```
- [ ] 批量处理模式
- [ ] 进度条显示
- [ ] 并行处理支持
- [ ] 汇总报告生成

**技术栈**:
- Click / Typer (CLI 框架)
- asyncio (并发处理)
- Rich (进度显示)

---

## 🧠 Phase 3: 语义与上下文智能 (0% 完成)

### 目标
引入 LLM 驱动的语义理解和解释生成，将系统从检查工具提升为智能助手。

### 待开发功能 📋

#### 1. **P3-F01: LLM 驱动的文本分析** (优先级: 高)
**目标**: 检查技术要求的语义质量

**核心功能**:
- [ ] 文本提取引擎
  - [ ] MTEXT 内容提取
  - [ ] 标题栏识别
  - [ ] 技术要求定位
- [ ] LLM 集成
  - [ ] Gemini API 对接
  - [ ] 提示词工程
  - [ ] 上下文管理
- [ ] 语义检查
  - [ ] 简化字验证 (GB/T 14665 5.4节)
  - [ ] 术语标准化检查
  - [ ] 表述清晰度评估
  - [ ] 矛盾检测
  - [ ] 完整性验证

**技术栈**:
- Google Gemini API / OpenAI API
- LangChain (LLM 编排)
- 自定义 Prompt 模板

**Prompt 示例**:
```
你是一位专业的机械工程审核员，精通 GB/T 14665-2012 标准。

请分析以下技术要求文本，检查：
1. 是否使用国家规定的简化字
2. 表述是否清晰、完整
3. 是否存在术语不规范或矛盾

技术要求文本：
"""
{text_content}
"""

以 JSON 格式输出发现的问题：
{
  "issues": [
    {
      "type": "terminology|clarity|contradiction",
      "severity": "high|medium|low",
      "description": "问题描述",
      "suggestion": "改进建议"
    }
  ]
}
```

#### 2. **P3-F02: 生成式错误解释** (优先级: 高)
**目标**: 为每个错误生成易懂的解释和修复指导

**核心功能**:
- [ ] 错误上下文收集
  - [ ] 图元属性
  - [ ] 周边环境
  - [ ] 标准条款
- [ ] 解释生成
  - [ ] 为什么这是错误
  - [ ] 可能的影响
  - [ ] 修复步骤
  - [ ] 最佳实践建议
- [ ] 多语言支持
  - [ ] 中文解释
  - [ ] 英文解释
  - [ ] 技术术语对照

**技术实现**:
```python
def generate_explanation(violation: Violation) -> str:
    prompt = f"""
    图纸违规项：
    - 类型: {violation.type}
    - 规则: {violation.rule}
    - 描述: {violation.description}
    
    请生成一段针对初级设计师的解释，说明：
    1. 为什么这违反了标准
    2. 可能产生的后果
    3. 如何修复（具体步骤）
    4. 相关最佳实践
    
    语言: 中文，口吻友好但专业
    长度: 150-200字
    """
    
    return llm.generate(prompt)
```

**示例输出**:
```
🔍 错误解释：

尺寸标注应放置在专用的尺寸图层上（如 DIM 或 DIMENSION），
而不是默认的 0 层。这样做有以下好处：

1. 便于统一管理和修改所有尺寸的样式
2. 可以快速隐藏/显示所有尺寸标注
3. 符合 GB/T 14665-2012 的图层规范要求

修复步骤：
1. 在 AutoCAD 中选中该尺寸标注（句柄: 4A3F）
2. 按 Ctrl+1 打开属性面板
3. 将"图层"修改为"DIM"
4. 如需批量修改，使用 CHPROP 命令

💡 最佳实践：
创建标准图层模板，新建图纸时自动包含标准图层。
```

#### 3. **P3-F03: 人在回路反馈系统** (优先级: 中)
**目标**: 收集用户反馈，持续改进 AI 模型

**核心功能**:
- [ ] 反馈界面
  - [ ] 正确/不正确按钮
  - [ ] 反馈理由输入
  - [ ] 快速评分系统
- [ ] 数据收集
  - [ ] 反馈数据库设计
  - [ ] ROI 图像存储
  - [ ] 用户标注管理
- [ ] 模型改进
  - [ ] 定期重训练流程
  - [ ] A/B 测试框架
  - [ ] 性能监控

**数据库设计**:
```sql
CREATE TABLE feedback (
    id UUID PRIMARY KEY,
    violation_id UUID,
    user_id UUID,
    is_correct BOOLEAN,
    reason TEXT,
    roi_image_path TEXT,
    created_at TIMESTAMP
);

CREATE TABLE model_versions (
    version VARCHAR(20) PRIMARY KEY,
    accuracy FLOAT,
    precision FLOAT,
    recall FLOAT,
    deployed_at TIMESTAMP
);
```

**改进循环**:
```
1. 收集反馈 (每周 100+ 样本)
     ↓
2. 数据清洗与标注
     ↓
3. 模型重训练 (每月)
     ↓
4. A/B 测试验证
     ↓
5. 逐步灰度发布
     ↓
6. 监控性能指标 → 回到步骤 1
```

#### 4. **智能推荐系统** (优先级: 低)
**目标**: 基于历史数据提供个性化建议

**核心功能**:
- [ ] 用户画像分析
- [ ] 常见错误模式识别
- [ ] 个性化检查侧重
- [ ] 团队标准学习
- [ ] 智能默认配置

---

## 🏗️ 基础设施与工程优化

### 1. **代码架构重构** (优先级: 高)
**问题**: 当前 backend/ 和 frontend/checker/ 代码重复

**解决方案**:
- [ ] 统一代码库
  - [ ] 提取共享模块到 `core/`
  - [ ] backend 和 serverless 共用核心逻辑
  - [ ] 单一配置文件
- [ ] 模块化设计
  ```
  core/
  ├── parser/      # 解析模块
  ├── checker/     # 检查模块
  ├── geometry/    # 几何引擎
  ├── models/      # 数据模型
  └── utils/       # 工具函数
  
  backend/         # FastAPI 服务
  frontend/api/    # Vercel Functions (引用 core/)
  ```

### 2. **性能优化** (优先级: 高)
**目标**: 支持大型图纸（>50MB）高效处理

**优化策略**:
- [ ] 流式解析
  - [ ] 分块读取大文件
  - [ ] 增量处理图元
- [ ] 并行处理
  - [ ] 多进程解析
  - [ ] 异步检查任务
- [ ] 缓存机制
  - [ ] Redis 缓存解析结果
  - [ ] 图层信息预计算
- [ ] 数据库优化
  - [ ] PostgreSQL 索引优化
  - [ ] 分区表设计

**性能目标**:
| 文件大小 | 当前耗时 | 目标耗时 |
|---------|---------|---------|
| < 5MB   | 15s     | 5s      |
| 5-20MB  | 45s     | 15s     |
| 20-50MB | 120s    | 30s     |
| > 50MB  | 超时    | 60s     |

### 3. **测试体系建设** (优先级: 高)
**当前状态**: 缺乏系统性测试

**测试策略**:
- [ ] 单元测试
  - [ ] 解析器测试 (pytest)
  - [ ] 检查器测试
  - [ ] 几何引擎测试
  - [ ] 目标覆盖率: 80%+
- [ ] 集成测试
  - [ ] API 端到端测试
  - [ ] 文件处理流程测试
- [ ] 样例库
  ```
  test_cases/
  ├── compliant/        # 合规样例
  │   ├── simple.dxf
  │   ├── complex.dxf
  │   └── standard.dxf
  ├── violations/       # 各类违规样例
  │   ├── layer_errors.dxf
  │   ├── lineweight_errors.dxf
  │   └── dimension_errors.dxf
  └── edge_cases/       # 边界情况
      ├── empty.dxf
      ├── huge.dxf
      └── corrupted.dxf
  ```
- [ ] CI/CD 集成
  - [ ] GitHub Actions 自动测试
  - [ ] Pre-commit hooks
  - [ ] 测试报告生成

### 4. **监控与日志** (优先级: 中)
**目标**: 生产环境可观测性

**核心功能**:
- [ ] 结构化日志
  - [ ] Python logging 标准化
  - [ ] 日志分级 (DEBUG/INFO/WARN/ERROR)
  - [ ] 上下文信息记录
- [ ] 性能监控
  - [ ] Prometheus 指标采集
  - [ ] Grafana 仪表板
  - [ ] 关键指标:
    - 文件处理耗时
    - API 响应时间
    - 错误率
    - 并发用户数
- [ ] 错误追踪
  - [ ] Sentry 集成
  - [ ] 异常堆栈收集
  - [ ] 用户影响分析
- [ ] 审计日志
  - [ ] 用户操作记录
  - [ ] 文件访问日志
  - [ ] 合规性审计

### 5. **安全性增强** (优先级: 高)
**风险**: 用户上传文件可能包含恶意内容

**安全措施**:
- [ ] 文件验证
  - [ ] 文件类型白名单
  - [ ] Magic number 检查
  - [ ] 文件大小限制
  - [ ] 恶意内容扫描
- [ ] 沙箱隔离
  - [ ] Docker 容器隔离
  - [ ] 临时文件加密
  - [ ] 处理完立即删除
- [ ] 访问控制
  - [ ] JWT 认证（后续）
  - [ ] Rate limiting
  - [ ] CORS 策略
- [ ] 数据加密
  - [ ] HTTPS 传输
  - [ ] 静态文件加密存储

---

## 📚 文档与社区

### 1. **用户文档** (优先级: 高)
- [x] 快速开始指南 (QUICK_START.md)
- [x] DWG 格式支持说明 (DWG_FORMAT_GUIDE.md)
- [x] 隐藏图元排查指南 (HIDDEN_ENTITIES_TROUBLESHOOTING.md)
- [ ] 完整用户手册
- [ ] 视频教程
- [ ] 常见问题 FAQ
- [ ] 最佳实践指南

### 2. **开发者文档** (优先级: 中)
- [ ] API 参考文档 (OpenAPI/Swagger)
- [ ] 架构设计文档
- [ ] 贡献指南 (CONTRIBUTING.md)
- [ ] 代码规范 (STYLE_GUIDE.md)
- [ ] 插件开发指南

### 3. **标准文档** (优先级: 中)
- [ ] GB/T 14665-2012 解读
- [ ] 规则配置说明
- [ ] 自定义规则开发
- [ ] 多标准支持指南

---

## 🎯 优先级矩阵

### 🔥 立即执行 (本周)
1. **代码统一重构** - 消除 backend/frontend 重复
2. **报告 PDF 导出** - 用户高频需求
3. **几何相交检测** - Phase 2 核心功能

### 🚀 近期规划 (本月)
1. **CV 数据集生成** - 启动模型训练准备
2. **交互式报告 UI** - 显著提升用户体验
3. **批处理 CLI** - 企业用户必备

### 📅 中期规划 (2-3个月)
1. **LLM 文本分析** - Phase 3 试点功能
2. **块递归解析** - 完善图元检测
3. **性能优化** - 支持大型图纸

### 🔮 长期愿景 (6个月+)
1. **多标准支持** (ANSI, ISO)
2. **CAD 插件开发** (AutoCAD, SolidWorks)
3. **可制造性分析**
4. **成本估算系统**

---

## 📊 技术债务清单

### 高优先级债务
1. **代码重复** - backend/ 和 frontend/checker/ 90% 重复
2. **测试缺失** - 单元测试覆盖率 < 20%
3. **错误处理** - 缺乏统一异常处理机制
4. **日志混乱** - 无结构化日志

### 中优先级债务
1. **配置管理** - 硬编码配置项较多
2. **文档滞后** - 代码更新快于文档
3. **性能瓶颈** - 大文件处理超时

### 低优先级债务
1. **UI 一致性** - 部分组件样式不统一
2. **国际化** - 文案硬编码

---

## 🤝 团队协作建议

### 如果有多人协作
```
角色分工：
- 后端工程师: 几何引擎 + CV 模型
- 前端工程师: 交互式报告 UI
- AI 工程师: LLM 集成 + 模型训练
- DevOps: 性能优化 + 监控部署
- 文档: 用户手册 + 标准解读
```

### 独立开发优先级
```
1. 先完成 Phase 1 剩余功能 (PDF导出、批处理)
2. 启动 Phase 2 几何引擎核心功能
3. 准备 CV 数据集生成
4. 逐步引入 Phase 3 LLM 功能
```

---

## 📈 成功指标 (KPI)

### 产品指标
- **用户增长**: 月活用户 1000+ (6个月内)
- **使用频率**: 周均检查文件 5000+
- **准确率**: 误报率 < 5%
- **用户满意度**: NPS > 50

### 技术指标
- **性能**: P95 响应时间 < 30s
- **可用性**: Uptime > 99.5%
- **测试覆盖率**: > 80%
- **代码质量**: SonarQube 评分 A

---

## 🎓 学习资源

### 必读标准
- GB/T 14665-2012 机械工程 CAD 制图规则
- GB/T 4457系列 技术制图标准
- ISO 128 技术图纸总则

### 推荐技术文档
- ezdxf Documentation
- Shapely User Manual
- PyTorch Tutorial
- LangChain Documentation

---

## 📝 更新日志

### 2025-10-18
- ✅ 完成隐藏图元检测功能
- ✅ 新增实体详细信息展示
- ✅ 创建完整项目开发计划
- 📋 Phase 2 几何引擎开发中 (15%)

### 2025-10-16
- ✅ 实现 DWG 格式支持
- ✅ 统一 /api/check 端点
- ✅ 完善报告导出功能

### 2025-10-13
- 🎉 项目启动
- ✅ 完成基础架构搭建
- ✅ 实现 DXF 文件解析

---

**当前关键任务**: 选择下一阶段开发重点 👇

A. **几何完善路线** - Block解析 + 相交检测 + 对齐算法  
B. **报告增强路线** - PDF导出 + 交互式UI + 批量处理  
C. **规则扩展路线** - 自定义规则 + CLI工具 + 样例库  
D. **性能优化路线** - 代码统一 + 大文件支持 + 监控系统

请选择优先级方向！
