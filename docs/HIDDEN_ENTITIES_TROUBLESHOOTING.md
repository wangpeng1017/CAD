# CAD 图元丢失或隐藏问题排查指南

## 问题现象

在 CAD 合规性检查过程中，您可能会遇到以下情况：
- ✅ 上传的文件大小正常
- ⚠️ 但检查结果显示图元数量少于预期
- ⚠️ 某些已知存在的尺寸标注或文字未被检测到
- ⚠️ 检查报告中提示"检测到隐藏的图元"

## 常见原因

### 1. **图层关闭（Layer Off）**
图层被设置为"关闭"状态，该图层上的所有图元不可见

**识别方法**：
- 检查报告中会显示：`图层关闭: X 个，涉及图层: LayerName`
- 在 CAD 软件中，图层管理器里该图层前有"关闭"图标（💡或灯泡符号）

**解决方案**：
```
1. 在 AutoCAD 中打开文件
2. 输入命令: LAYER (或 LA)
3. 找到关闭的图层，点击"开/关"图标使其打开
4. 或使用快捷命令: LAYON（打开所有图层）
5. 保存并重新导出为 DXF
```

### 2. **图层冻结（Layer Frozen）**
图层被冻结，无法显示和编辑

**识别方法**：
- 检查报告中会显示：`图层冻结: X 个，涉及图层: LayerName`
- 在图层管理器中该图层显示雪花或冰冻图标 ❄️

**解决方案**：
```
1. 在 AutoCAD 中打开文件
2. 输入命令: LAYER (或 LA)
3. 找到冻结的图层，点击"冻结/解冻"图标
4. 或使用快捷命令: LAYTHA（解冻所有图层）
5. 保存并重新导出为 DXF
```

### 3. **图元不可见属性（Invisible Flag）**
个别图元被设置了不可见标志

**识别方法**：
- 检查报告中会显示：`检测到 X 个设置了不可见属性的图元`
- 这种情况较少见，通常是由特殊插件或脚本造成

**解决方案**：
```
1. 在 AutoCAD 中选中所有对象: CTRL+A
2. 打开属性面板: CTRL+1
3. 检查"可见性"属性是否为"是"
4. 如有问题，批量修改为"是"
```

### 4. **图层锁定（Layer Locked）**
图层被锁定，虽然可见但无法编辑

**说明**：
- 锁定的图层**不会**影响图元检测
- 系统会正常读取和检查这些图元
- 报告中会记录图层锁定状态供参考

### 5. **块（Block）中的图元**
图元在块定义内部，而不是直接在模型空间

**说明**：
- 当前版本会提取块引用信息
- 未来版本会递归检查块内部的图元

## 最佳实践：导出前的检查清单

### ✅ 步骤 1: 检查图层状态
```autocad
命令: LAYER
操作:
- 点击"全部打开"按钮
- 点击"全部解冻"按钮
- 点击"全部解锁"按钮（可选）
```

### ✅ 步骤 2: 清理图纸
```autocad
命令: PURGE
操作: 清理未使用的图层、块等
```

### ✅ 步骤 3: 审查（Audit）
```autocad
命令: AUDIT
回答: Y (修复错误)
```

### ✅ 步骤 4: 导出为 DXF
```autocad
命令: SAVEAS
文件类型: AutoCAD DXF (*.dxf)
版本: AutoCAD 2018/LT2018 或更高
```

### ✅ 步骤 5: 验证导出
- 重新打开导出的 DXF 文件
- 确认所有图元都可见
- 再次上传到检查系统

## 使用脚本批量处理

如果您经常遇到这类问题，可以使用以下 AutoLISP 脚本自动化处理：

```lisp
;; 打开所有图层并解冻
(defun c:FIXLAYERS ()
  (command "._-LAYER" "_ON" "*" "_THAW" "*" "_UNLOCK" "*" "")
  (princ "\n所有图层已打开、解冻并解锁")
  (princ)
)

;; 使用方法：在 AutoCAD 命令行输入 FIXLAYERS
```

将以上代码保存为 `fixlayers.lsp`，在 AutoCAD 中使用 `APPLOAD` 命令加载并运行。

## 检查报告中的提示

系统会在检查报告中自动检测并提示：

### 🚨 警告级别（黄色）
```
检测到隐藏的图元，可能导致图纸不完整
- 图层关闭: 15 个，涉及图层: DIM, TEXT
- 图层冻结: 3 个，涉及图层: NOTES
```

**建议**: 必须处理，这些图元完全不可见

### 💡 提示级别（蓝色）
```
检测到 5 个设置了不可见属性的图元
```

**建议**: 检查确认，可能是正常的隐藏辅助图元

## 技术原理

系统使用 `ezdxf` 库解析 DXF 文件，会检查以下属性：

| 属性 | 说明 | 影响 |
|------|------|------|
| `layer.is_off()` | 图层关闭 | 图元不可见 ❌ |
| `layer.is_frozen()` | 图层冻结 | 图元不可见 ❌ |
| `layer.is_locked()` | 图层锁定 | 图元可见但不可编辑 ✅ |
| `entity.dxf.invisible` | 图元不可见标志 | 该图元不可见 ⚠️ |

## 常见问题 FAQ

### Q: 为什么我在 CAD 中看到的图元，检查系统检测不到？
**A**: 最可能的原因是图层关闭或冻结。系统会如实报告 DXF 文件的状态。在导出前请确保所有图层都打开并解冻。

### Q: 锁定的图层会影响检查吗？
**A**: 不会。锁定只影响编辑权限，不影响可见性和检查。

### Q: 如何知道哪些图层被隐藏了？
**A**: 检查报告的"实体信息"部分会列出所有受影响的图层名称。

### Q: 我需要重新绘图吗？
**A**: 不需要！只需打开图层、解冻图层，然后重新保存即可。

### Q: 批量处理多个文件怎么办？
**A**: 可以使用 AutoCAD 的 ScriptPro 工具或编写批处理脚本自动化处理。

## 进一步帮助

如果按照以上步骤仍无法解决问题，请：
1. 导出完整的检查报告（JSON 格式）
2. 记录您的操作步骤
3. 联系技术支持并提供相关文件

---

**相关文档**:
- [DWG 格式支持指南](./DWG_FORMAT_GUIDE.md)
- [合规性检查规则说明](./COMPLIANCE_RULES.md)

**更新日期**: 2025-10-17
